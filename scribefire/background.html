<script>

function openScribeFire() {
	var scribefireUrl = chrome.extension.getURL('scribefire.html');
	
	// Check for a tab already with this URL.
	chrome.tabs.getAllInWindow(null, function (tabs) {
		for (var i = 0; i < tabs.length; i++) {
			if (tabs[i].url == scribefireUrl) {
				chrome.tabs.update(tabs[i].id, { "selected" : true });
				
				if (localStorage["extensions.scribefire.blogThis"]) {
					chrome.tabs.update(tabs[i].id, { "url" : scribefireUrl });
				}
				
				return;
			}
		}
		
		chrome.tabs.create({"url": scribefireUrl});
	});
}

chrome.browserAction.onClicked.addListener(function(tab) {
	openScribeFire();
});

function scribefireContextClick(info, tab) {
	var htmlToInsert = "";
	
	if (info.linkUrl) {
		if (info.selectionText) {
			htmlToInsert = '<a href="' + info.linkUrl + '">'+info.selectionText.replace(/\n/g, "<br/>")+'</a>';
		}
		else {
			htmlToInsert = '<a href="' + info.linkUrl + '">Your link text here.</a>';
		}
	}
	else if (info.pageUrl) {
		if (info.selectionText) {
			htmlToInsert = '<a href="' + info.pageUrl + '">'+info.selectionText.replace(/\n/g, "<br/>")+'</a>';
		}
		else {
			htmlToInsert = '<a href="' + info.pageUrl + '">Your link text here.</a>';
		}
	}
	else if (info.selectionText) {
		htmlToInsert = info.selectionText.replace(/\n/g, "<br/>");
	}
	else if (info.mediaType == "video") {
		htmlToInsert = '<video src="' + info.srcUrl + '"></video>';
	}
	else if (info.mediaType == "audio") {
		htmlToInsert = '<audio src="' + info.srcUrl + '"></audio>';
	}
	else if (info.mediaType == "image") {
		htmlToInsert = '<img src="' + info.srcUrl + '" />';
	}
	
	localStorage["extensions.scribefire.blogThis"] = htmlToInsert;
	
	openScribeFire();
}

var contexts = {
	"page" : "Blog This Page",
	"selection" : "Blog Selected Text",
	"link" : "Blog This Link",
	"image" : "Blog This Image",
	"video" : "Blog This Video",
	"audio" : "Blog This Audio"
};

for (var i in contexts) {
	var context = i;
	var title = contexts[i];
	
	var id = chrome.contextMenus.create( { "title" : title, "contexts" : [ context ], "onclick": scribefireContextClick } );
}

</script>