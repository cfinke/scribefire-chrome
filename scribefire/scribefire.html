<html>
	<head>
		<title>ScribeFire</title>
		<link rel="stylesheet" type="text/css" href="skin/style.css" />
		<link rel="stylesheet" type="text/css" href="skin/facebox.css" />
		<script type="text/javascript" src="util.js"></script>
		<script type="text/javascript" src="xmlrpc.js"></script>
		<script type="text/javascript" src="apis.js"></script>
		<script type="text/javascript" src="scribefire.js"></script>
		<script type="text/javascript" src="lib/jquery.js"></script>
		<script type="text/javascript" src="lib/parseUri.js"></script>
		<script type="text/javascript" src="lib/facebox.js"></script>
		<script type="text/javascript" src="lib/ckeditor/ckeditor.js"></script>
		<script type="text/javascript" src="lib/ckeditor/adapters/jquery.js"></script>
		<script type="text/javascript" src="lib/persist.js"></script>
		<script type="text/javascript" src="lib/keyboard.js"></script>
	</head>
	<body>
		<div>
			<div>
				<div class="bar bar-selected" id="bar-blog">
					<label>Blog: <span id="label-current-blog"></span></label>
				</div>
				<div class="underbar underbar-selected" id="underbar-blog">
					<select id="list-blogs"></select>
					<p>
						<button id="button-blog-add">New Blog</button>
						<!--<button id="button-blog-edit">Edit</button>-->
						<button id="button-blog-remove">Remove</button>
					</p>
					<div id="dialog-blog-add" style="display:none;">
						<input type="hidden" id="text-addblog-id" />
						<div class="step-1">
							<div class="subbar subbar-selected">
								<label>URL: <span id="label-add-blog-url"></span></label>
							</div>
							<div class="subunderbar subunderbar-selected">
								<input type="text" id="text-blog-url" accept="button-blog-urlcheck" cancel="button-addblog-cancel" />
								<p>
									<button id="button-blog-urlcheck">Next</button>
									<button id="button-addblog-cancel">Cancel</button>
								</p>
							</div>
						</div>
						<div class="step-2">
							<div class="subbar" disabled="true">
								<label>Blog Type: <span id="label-add-blog-type"></span></label>
							</div>
							<div class="subunderbar">
								<select id="list-blog-types" disabled="disabled">
									<option vlaue="">(select)</option>
									<option value="wordpress">Wordpress</option>
									<option value="blogger_atom">Blogger</option>
									<!-- <option value="blogger">Blogger (Old)</option> -->
									<!-- <option value="typepad">TypePad</option> -->
									<option value="tumblr">Tumblr</option>
									<option value="metaweblog">MetaWeblog</option>
									<option value="movabletype">MovableType</option>
								</select>
							</div>
						</div>
						<div class="step-2">
							<div class="subbar" disabled="true">
								<label>API URL: <span id="label-add-blog-apiurl"></span></label>
							</div>
							<div class="subunderbar">
								<input type="text" id="text-blog-api-url" disabled="disabled" />
							</div>
						</div>
						<div class="step-2">
							<div class="subbar" disabled="true">
								<label>Login Credentials</label>
							</div>
							<div class="subunderbar">
								<label>Username</label>
								<input type="text" id="text-blog-username" disabled="disabled" accept="button-blog-logincheck" />
								<label>Password</label>
								<input type="password" id="text-blog-password" disabled="disabled" accept="button-blog-logincheck" />
								<p>
									<button id="button-blog-logincheck">Finish</button>
								</p>
							</div>
						</div>
						<div class="step-3">
							
						</div>
					</div>
				</div>
			</div>
			<div>
				<div class="bar" id="bar-entries">
					<label>Entry: <span id="label-current-entry"></span></label>
				</div>
				<div class="underbar" id="underbar-entries">
					<select id="list-entries"><option value="">(new)</option></select>
					<button id="button-entry-remove" style="display: none;">Delete Post</button>
				</div>
			</div>
			<div>
				<div class="bar bar-selected" id="bar-title">
					<label>Title: <span id="label-current-title"></span></label>
				</div>
				<div class="underbar underbar-selected" id="underbar-title">
					<input type="text" id="text-title" />
				</div>
			</div>
			<div>
				<div class="bar bar-selected" id="bar-content">
					<label>Post Content</label>
				</div>
				<div class="underbar underbar-selected" id="underbar-content">
					<textarea rows="10" id="text-content"></textarea>
				</div>
			</div>
			<div id="ui-categories">
				<div class="bar" id="bar-categories">
					<label>Categories: <span id="label-current-categories"></span></label>
				</div>
				<div class="underbar" id="underbar-categories">
					<select id="list-categories" multiple="true"></select>
					<button id="button-category-add">New Category</button>
				</div>
			</div>
			<div id="ui-tags">
				<div class="bar" id="bar-tags">
					<label>Tags: <span id="label-current-tags"></span></label>
				</div>
				<div class="underbar" id="underbar-tags">
					<input type="text" id="text-tags" />
				</div>
			</div>
		</div>
		<div>
			<div class="bar bar-selected" id="bar-publish">
				<label>Publish</label>
			</div>
			<div class="underbar underbar-selected" id="underbar-publish">
				<input type="checkbox" id="checkbox-draft" /> <label>Draft</label>
				<button id="button-publish">Publish Post</button>
			</div>
		</div>
		<script>
			$(document).ready(function () {
				$("#button-category-add").click(function (e) {
					e.preventDefault();
					
					var button = $(this);
					button.addClass("busy");
					
					var categoryName = prompt("New category name:");
					
					if (categoryName) {
						function callback() {
							button.removeClass("busy");
						}
						
						SCRIBEFIRE.addCategory(categoryName, callback, callback);
					}
					else {
						button.removeClass("busy");
					}
				});
				
				$("#button-addblog-cancel").click(function (e) {
					e.preventDefault();
					
					$("#dialog-blog-add").hide();	
					
					// @todo Cancel any requests.
					$("#button-blog-urlcheck").removeClass("busy");
				});
				
				$("#button-blog-remove").click(function (e) {
					e.preventDefault();
					
					if (confirm("Are you sure?")) {
						SCRIBEFIRE.removeBlog($("#list-blogs").val());
					}
				});
				
				$("#button-entry-remove").click(function (e){
					e.preventDefault();
					
					var button = $(this);
					button.addClass("busy");
					
					if (confirm("Are you sure?")) {
						function callback() {
							button.removeClass("busy");
						}
						
						SCRIBEFIRE.deletePost(
							$("#list-entries").val(),
							function success() {
								SCRIBEFIRE.notify("Post deleted successfully.");
								
								SCRIBEFIRE.clearData();
								
								button.removeClass("busy");
							},
							function failure() {
								button.removeClass("busy");
							}
						);
					}
				});
				
				$(".bar").click(function () {
					if ($(this).attr("disabled") != "true") {
						if ($(this).hasClass("bar-selected")) {
							$(this).removeClass("bar-selected");
							$(this).parent().find(".underbar:first").removeClass("underbar-selected");
						}
						else {
							$(this).addClass("bar-selected");
							$(this).parent().find(".underbar:first").addClass("underbar-selected");
						}
					}
					
					$(this).persist("class");
					$(this).parent().find(".underbar:first").persist("class");
				});

				$(".subbar").click(function () {
					if ($(this).attr("disabled") != "true") {
						$(this).parent().find(".subunderbar:first").toggle();
					
						if ($(this).hasClass("subbar-selected")) {
							$(this).removeClass("subbar-selected");
						}
						else {
							$(this).addClass("subbar-selected");
						}
					}
				});
				
				$("#text-title").change(function () {
					$("#label-current-title").html($(this).val());
				});
				
				$("#text-tags").change(function () {
					$("#label-current-tags").html($(this).val());
				});
				
				$("#list-blogs").change(function () {
					if (!$(this).val()) {
						$("#button-blog-edit, #button-blog-remove").hide();
					}
					else {
						$("#button-blog-edit, #button-blog-remove").remove();
						SCRIBEFIRE.populateEntriesList();
						SCRIBEFIRE.populateCategoriesList();
					}
					
					SCRIBEFIRE.prefs.setCharPref("selectedBlog", $(this).val());
					$("#label-current-blog").html($(this).find("option:selected").text());
					
					SCRIBEFIRE.updateOptionalUI();
				});
				
				$("#list-entries").change(function () {
					var postId = $(this).val();
					
					if (!postId) {
						$("#button-entry-remove").hide();
						$("#button-publish").html("Publish Post");
					}
					else {
						$("#button-entry-remove").show();
						$("#button-publish").html("Publish Edited Post");
						
						var entry = $(this).find("option:selected");
						
						$("#text-title").val(entry.attr("title")).change();
						$("#text-content").val(entry.attr("content"));
						$("#checkbox-draft").attr("checked", entry.attr("published") == "false");
						$("#text-tags").val(entry.attr("tags"));
						
						SCRIBEFIRE.getAPI().getPostCategories(
							{ "id" : postId },
							function success (categories) {
								$("#list-categories").val(categories).change();
							},
							function failure(rv) {
								rv.func = "getPostCategories";
								SCRIBEFIRE.genericError(rv);
							}
						);
					}
					
					SCRIBEFIRE.prefs.setCharPref("selectedEntry", $(this).val());
					
					$("#label-current-entry").html($(this).find("option:selected").text());
				});
				
				$("#list-categories").change(function (e) {
					if (!$(this).val()) {
						$("#label-current-categories").val("(none)");
					}
					else {
						var categories = [];
						
						$(this).find("option:selected").each(function () {
							categories.push($(this).text());
						});
						
						$("#label-current-categories").html(categories.join(", "));
					}
				});
				
				$("#button-blog-add").click(function (e) {
					$("#dialog-blog-add").show();
					
					$("#text-blog-url").val("").change();
					$("#list-blog-types").val("");
					$("#text-blog-api-url").val("");
					$("#text-blog-username").val("");
					$("#text-blog-password").val("");
					$("#text-addblog-id").val("");
					
					$("#dialog-blog-add .step-2 .subbar").attr("disabled", "true").removeClass("subbar-selected");
					$("#dialog-blog-add .step-2 .subunderbar").removeClass("subunderbar-selected");
					$("#dialog-blog-add .step-2").find("input, select").attr("disabled", "true");
					$("#dialog-blog-add .step-2 .subunderbar").hide();
					
					$("#text-blog-url").focus();
				});
				
				$("#button-blog-urlcheck").click(function (e) {
					var button = $(this);
					
					button.addClass("busy");
					
					SCRIBEFIRE.getBlogMetaData(
						$("#text-blog-url").val(),
						function (metaData) {
							button.removeClass("busy");
							
							if (metaData) {
								$("#list-blog-types").val(metaData.type);
								$("#list-blog-types").removeAttr("disabled");
								
								$("#text-blog-api-url").val(metaData.apiUrl);
								$("#text-blog-api-url").removeAttr("disabled");
								
								if (metaData.id) {
									$("#text-addblog-id").val(metaData.id);
								}
								
								$("#dialog-blog-add .step-2 *[disabled]").removeAttr("disabled");
								$("#dialog-blog-add .step-2 .subbar").click();
								
								$("#text-blog-username").focus();
							}
						},
						function failure(code, status) {
							button.removeClass("busy");
							
							SCRIBEFIRE.error("While trying to determine your blog's settings, ScribeFire tripped over this code: " + code);
						}
					);
				});
				
				$("#button-blog-logincheck").click(function (e) {
					var button = $(this);
					button.addClass("busy");
					
					var params = {
						apiUrl : $("#text-blog-api-url").val(),
						type : $("#list-blog-types").val(),
						username : $("#text-blog-username").val(),
						password : $("#text-blog-password").val(),
						blogUrl : $("#text-blog-url").val()
					};
					
					if ($("#text-addblog-id").val()) {
						params.id = $("#text-addblog-id").val();
					}
					
					SCRIBEFIRE.getBlogs(
						params,
						function (rv) {
							button.removeClass("busy");
							
							$("#list-blogs").val(rv[0].url).change();
							$("#dialog-blog-add").hide();
							SCRIBEFIRE.clearData();
							
							SCRIBEFIRE.notify("Your blog was added successfully!");
						},
						function (rv) {
							button.removeClass("busy");
						}
					);
				});
				
				$("#button-publish").click(function (e) {
					e.preventDefault();
					
					var button = $(this);
					button.addClass("busy");
					
					function callback() {
						button.removeClass("busy");
					}
					
					SCRIBEFIRE.publish(
						function success(rv) {
							button.removeClass("busy");
							SCRIBEFIRE.notify("Post published successfully!", "Open blog in a new tab", function (button) { chrome.tabs.create({ "url": rv.url }) });
						},
						function error(rv) {
							button.removeClass("busy");
						});
				});
				
				$("#text-content").ckeditor();
/*					function () { },
					{
						on : {
							instanceReady : function (e) {
								this.dataProcessor.writer.setRules('p', {
									indent: false,
									breakAfterOpen: false
								});
							}
						}
					}
				);
				*/
				SCRIBEFIRE.load();
			});
		</script>
	</body>
</html>